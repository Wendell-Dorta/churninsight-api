services:
  # ============================================================================
  # APLICAÇÃO (BACKEND & BANCO)
  # ============================================================================
  db:
    image: mysql:8.0
    container_name: churn-db
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --performance-schema=OFF
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - churn-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  app:
    # Atenção: Certifique-se que DOCKER_USERNAME está no .env
    image: ${DOCKER_USERNAME}/churn-api:latest
    container_name: churn-api
    restart: on-failure
    pull_policy: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/${DB_NAME}?allowPublicKeyRetrieval=true&useSSL=false
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SERVER_PORT: ${APP_PORT}
    env_file:
      - .env

      # Variáveis de segurança injetadas no container
      SECURITY_USER: ${SECURITY_USER}
      SECURITY_PASSWORD: ${SECURITY_PASSWORD}
      SECURITY_ROLES: ${SECURITY_ROLES}

    ports:
      - "${APP_PORT}:${APP_PORT}"
    networks:
      - churn-net
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1024M

  # ============================================================================
  # AUTOMACAO DE DEPLOY (INFRA) - ADICIONADO PARA O SERVIDOR
  # ============================================================================
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Monitora, atualiza e remove imagens velhas a cada 30s
    command: --interval 30 --cleanup
    networks:
      - churn-net

  # ============================================================================
  # STACK DE OBSERVABILIDADE
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: monitoring-prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "${PROMETHEUS_PORT}:${PROMETHEUS_PORT}"
    networks:
      - churn-net

  grafana:
    image: grafana/grafana:latest
    container_name: monitoring-grafana
    ports:
      - "${GRAFANA_PORT}:${GRAFANA_PORT}"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=alexanderzobnin-zabbix-app
      - ZABBIX_USER=${ZABBIX_USER}
      - ZABBIX_PASSWORD=${ZABBIX_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
      - zabbix-web
    networks:
      - churn-net

  # ZABBIX
  zabbix-server:
    image: zabbix/zabbix-server-mysql:latest
    container_name: zabbix-server
    ports:
      - "${ZABBIX_SERVER_PORT}:${ZABBIX_SERVER_PORT}"
    environment:
      - DB_SERVER_HOST=zabbix-db
      - MYSQL_USER=zabbix
      - MYSQL_PASSWORD=${MYSQL_ZABBIX_PASSWORD}
      - MYSQL_DATABASE=zabbix
    depends_on:
      - zabbix-db
    networks:
      - churn-net

  zabbix-web:
    image: zabbix/zabbix-web-nginx-mysql:latest
    container_name: zabbix-web
    restart: always
    ports:
      - "${ZABBIX_WEB_PORT}:8080"
    environment:
      - DB_SERVER_HOST=zabbix-db
      - MYSQL_USER=zabbix
      - MYSQL_PASSWORD=${MYSQL_ZABBIX_PASSWORD}
      - MYSQL_DATABASE=zabbix
      - ZBX_SERVER_HOST=zabbix-server
      - PHP_TZ=America/Sao_Paulo
    depends_on:
      - zabbix-server
    networks:
      - churn-net

  zabbix-db:
    image: mysql:8.0
    container_name: zabbix-db
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_bin
      - --default-authentication-plugin=mysql_native_password
      - --log_bin_trust_function_creators=1
    environment:
      - MYSQL_USER=zabbix
      - MYSQL_PASSWORD=${MYSQL_ZABBIX_PASSWORD}
      - MYSQL_DATABASE=zabbix
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_ZABBIX_PASSWORD}
    volumes:
      - zabbix_db_data:/var/lib/mysql
    networks:
      - churn-net
    deploy:
      resources:
        limits:
          memory: 1024M

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel --url http://app:${APP_PORT} --metrics 0.0.0.0:2000
    networks:
      - churn-net
    depends_on:
      - app

networks:
  churn-net:
    driver: bridge

volumes:
  mysql_data:
  zabbix_db_data:
  grafana_data: